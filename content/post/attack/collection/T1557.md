---
title: "收集——中间人攻击"
date: 2023-05-14T20:38:48+08:00
draft: false
---



## 中间人攻击(T1557)


攻击者可能会尝试使用中间人攻击（AiTM）技术，将自己置于两个或多个网络设备之间，以支持后续行为，如网络嗅探(T1040)或传输数据篡改(T1565-002)。
通过滥用常见网络协议的功能（例如ARP、DNS、LLMNR等），攻击者可能会强制设备通过攻击者控制的系统进行通信，以便收集信息或执行其他操作。[[1]](#1)

例如，攻击者可能操纵受害者的DNS设置，以便进行其他恶意活动，如防止/重定向用户访问合法网站并且/或者推送其他恶意软件。[2](#2)[3](#3)[4](#4)
攻击者还可以操纵DNS并利用其位置拦截用户凭据和会话Cookie。
降级攻击也可以用于建立AiTM位置，例如通过协商通信协议（SSL/TLS）或加密算法的较低安全性、废弃版本或较弱版本。

攻击者也可能利用AiTM的位置来尝试监视和/或修改流量，例如在传输数据篡改中。对手可以设置类似于AiTM的位置，以防止流量流向适当的目标，潜在的削弱防御和/或支持网络拒绝服务攻击。

### 操作示例(Procedure Examples)

|  ID   | 名称  | 描述|
|  ----  | ----  |----|
| [S0281]()  |  Dok| Dok代理web流量，潜在的监视和更改受害者的HTTP（S）流量。|
| [G0094]()  | 	Kimsuky |Kimsuky使用修改版的PHProxy来测试受害者和被访问网站之间的网络流量。|

### 缓解措施（Mitigations）

|  ID   | 缓解措施  | 描述|
|  ----  | ----  |----|
| [M1042]()  |  禁用或删除功能或程序（Disable or Remove Feature or Program）| 如果适用的话，禁用可能被用来拦截网络流量的传统网络协议，特别是那些在环境中不需要的协议。|
| [M1041]()  | 	加密敏感信息（Encrypt Sensitive Information） |确保所有有线和/或无线流量都得到适当的加密。使用最佳实践进行身份验证协议，例如Kerberos，并确保可能包含凭据的Web流量受到SSL/TLS的保护。|
|[M1037]()|过滤网络流量|使用网络设备和基于主机的安全软件来阻止不必要的网络流量，例如可能被利用于AiTM条件的旧协议。|
|[M1035]()|限制网络资源访问|限制对可以被用于重塑流量或者产生AiTM条件的网络基础设施和资源的访问。|
|[M1031]()|网络入侵防范|能够识别表明AiTM活动的流量模式的网络入侵检测和预防系统可用于缓解网络层面的活动。|
|[M1030]()|网络分段（网段）|网络分割可用于隔离不需要广泛网络访问的基础设施组件。这可以减轻AiTM活动的范围。|
|[M1017()]|人员培训|培训用户对证书错误保持怀疑，攻击者可能使用他们自己的证书来尝试拦截HTTPS流量。当应用程序的证书与主机所期望的证书不一致时，可能会出现证书错误。|

### 检测

|  ID   | 数据源  | 数据组件|检测|
|  ----  | ----  |----|----|
| [DS0015]()  |应用程序日志| 应用程序日志内容|监控应用程序日志，以检测与网络协议和其他常被滥用于AiTM的服务相关的设置更改和其他事件。|
| [DS0029]()  |网络流量|网络流量内容|监控网络流量，以检测与已知AiTM行为相关的异常情况。|
|[DS0029]()|网络流量|网络流量流|监控来自未知/意外硬件设备的网络流量。本地网络流量元数据（例如源MAC地址）以及使用DHCP等网络管理协议可能有助于识别硬件。|
|[DS0019]()|服务|服务创建|通过Windows事件日志监控新构建的服务/守护程序，关注事件ID 4697和7045。数据和事件不应孤立地看待，而是作为一系列行为链的一部分来考虑，这可能会导致其他活动，例如远程登录或进程创建事件。|
|[DS0024]()|Windows注册表|Windows注册表键修改|监视 HKLM\Software\Policies\Microsoft\Windows NT\DNSClient 的更改，以查看“EnableMulticast”DWORD值。 值为“0”表示已禁用LLMNR。|

### 子技术

|  ID   | 名称  |
|  ----  | ----  |
| [T1557.001](#中间人攻击llmnrnbt-ns中毒和smb中继)  | 链路本地多播名称解析(Link-Local Multicast Name Resolution)/网络基本输入输出系统-命名服务(Network Basic Input/Output System-Name Service) |
| [T1557.002](#中间人攻击arp缓存中毒)  | 地址解析协议缓存中毒(ARP Cache Poisoning) |
| [T1557.003](#中间人攻击dhcp欺骗)| 动态主机配置协议欺骗(DHCP Spoofing)|

## 中间人攻击：LLMNR/NBT-NS中毒和SMB中继
通过响应LLMNR/NBT-NS网络流量，攻击者可能会欺骗权威名称解析源，以强制与受攻击方控制的系统通信。这种活动可能被用于收集或中继认证材料。

链路本地多播名称解析（LLMNR）和NetBIOS名称服务（NBT-NS）是微软Windows的组件，它们作为主机识别的备选方法。 LLMNR基于域名系统（DNS）格式，并允许同一本地链路上的主机执行其他主机的名称解析。 NBT-NS通过其NetBIOS名称标识本地网络上的系统。

攻击者可以欺骗受害网络上的权威名称解析源，通过响应LLMNR（UDP 5355）/NBT-NS（UDP 137）流量来伪装自己知道所请求主机的身份，有效地污染服务，以便受害者将与攻击者控制的系统通信。如果所请求的主机属于需要识别/认证资源，则用户名和NTLMv2哈希将被发送到攻击者控制的系统。然后，攻击者可以通过监视端口进行流量或通过网络嗅探收集在传输过程中发送的哈希信息，并通过暴力破解离线破解哈希以获取明文密码。

在某些情况下，当攻击者可以访问位于系统身份验证路径之间的系统或使用凭据进行身份验证的自动化扫描尝试对攻击者控制的系统进行身份验证时，NTLMv1/v2哈希值可能会被拦截并中继以访问和执行针对目标系统的代码。中继步骤可以与毒化同时发生，但也可能独立于其之外。此外，攻击者还可以将NTLMv1/v2哈希值封装到各种协议（如LDAP、SMB、MSSQL和HTTP）中，以扩展并使用多个具有有效NTLM响应的服务。

在本地网络中，可以使用多种工具来攻击命名服务，例如NBNSpoof、Metasploit和Responder。

### 操作示例

|  ID   | 名称  | 描述|
|  ----  | ----  |----|
| [S0363]()  |  Empire| Empire可以使用Inveigh进行名称服务中毒，以窃取凭据并进行关联的中继攻击。[8][9]|
| [S0357]()  | 	Impacket |Impacket模块，如ntlmrelayx和smbrelayx，可以与网络嗅探、LLMNR/NBT-NS毒化和SMB Relay结合使用，收集NetNTLM凭据以进行暴力破解或中继攻击，并获得代码执行。|
| [G0032]()  | 	Lazarus Group |Lazarus Group使用命令[Responder文件路径] -i [IP地址] -rPv在受感染的主机上执行了Responder，以收集凭据并进行横向移动。|
| [S0378]()  | 	PoshC2 |PoshC2可以使用Inveigh进行名称服务投毒，以实现凭证窃取和相关的中继攻击。|
| [S0192]()  | 	Pupy |Pupy可以嗅探明文网络凭据，并使用NBNS欺骗来污染名称服务|
| [S0174]()  | 	Responder |Responder被用于对名字服务进行攻击，以从本地网络中的系统中收集哈希和凭据。|
| [G0102]()  | 	Wizard Spider |Wizard Spider使用了Invoke-Inveigh PowerShell cmdlets，很可能用于名称服务中毒。|

### 缓解措施


|  ID   | 缓解措施  | 描述|
|  ----  | ----  |----|
| [M1042]()  |  禁用或删除功能或程序（Disable or Remove Feature or Program）|如果在环境中不需要LLMNR和NetBIOS，则可以通过本地计算机安全设置或组策略禁用它们。|
|[M1037]()|过滤网络流量|使用基于主机的安全软件来阻止LLMNR/NetBIOS流量。启用SMB签名可以阻止NTLMv2中继攻击。|
|[M1031]()|网络入侵防范|能够识别表明AiTM活动的流量模式的网络入侵检测和预防系统可用于缓解网络层面的活动。|
|[M1030]()|网络分段（网段）|网络分割可用于隔离不需要广泛网络访问的基础设施组件。这可以减轻AiTM活动的范围。|


### 检测

|  ID   | 数据源  | 数据组件|检测|
|  ----  | ----  |----|----|
| [DS0029]()  |网络流量|网络流量内容|如果LLMNR/NetBIOS被安全策略禁用，请监视UDP 5355和UDP 137端口的流量。|
|[DS0029]()|网络流量|网络流量流|监控来自未知/意外硬件设备的网络流量。本地网络流量元数据（例如源MAC地址）以及使用DHCP等网络管理协议可能有助于识别硬件。|
|[DS0019]()|服务|服务创建|通过Windows事件日志监控新构建的服务/守护程序，关注事件ID 4697和7045。部署LLMNR / NBT-NS欺骗检测工具。|
|[DS0024]()|Windows注册表|Windows注册表键修改|监视 HKLM\Software\Policies\Microsoft\Windows NT\DNSClient 的更改，以查看“EnableMulticast”DWORD值。 值为“0”表示已禁用LLMNR。|

## 中间人攻击：ARP缓存中毒

攻击者可能会毒化地址解析协议（ARP）缓存，以便将自己置于两个或多个网络设备之间的通信中。这种活动可能被用来启用后续行为，例如网络嗅探或传输数据篡改。

ARP协议用于将IPv4地址解析为链路层地址，例如媒体访问控制（MAC）地址。局域网段中的设备通过使用链路层地址相互通信。如果网络设备没有特定网络设备的链路层地址，则可能向本地网络发送广播ARP请求以将IP地址转换为MAC地址。关联IP地址的设备直接回复其MAC地址。发出ARP请求的网络设备随后将在其ARP缓存中使用并存储该信息。

攻击者可能会被动等待ARP请求，以毒化请求设备的ARP缓存。攻击者可以回复他们的MAC地址，从而欺骗受害者使其相信自己正在与预期的网络设备通信。为了毒化ARP缓存，攻击者的回复必须比合法IP地址所有者更快。攻击者还可能发送一个无回报的ARP回复（没有arp请求的回复），向本地网段的所有设备恶意宣布一个特定IP地址的所有权。

ARP协议是无状态的，不需要进行身份验证。因此，设备可能会错误地将MAC地址添加或更新到其ARP缓存中。

攻击者可能会利用ARP缓存中毒作为拦截网络流量的手段。这种活动可以用来收集和/或中继数据，例如凭据，特别是那些通过不安全、未加密协议发送的数据。

### 操作示例

|  ID   | 名称  | 描述|
|  ----  | ----  |----|
| [G0003]()  |  Cleaver| Cleaver使用了定制工具来促进ARP缓存中毒。|
| [G1014]()  | 		LuminousMoth |LuminousMoth使用ARP欺骗将被攻击的机器重定向到一个由攻击者控制的网站。|


### 缓解措施


|  ID   | 缓解措施  | 描述|
|  ----  | ----  |----|
| [M1042]()  |  禁用或删除功能或程序（Disable or Remove Feature or Program）|考虑禁用在收到无回报ARP时更新ARP缓存。|
| [M1041]()  | 	加密敏感信息（Encrypt Sensitive Information） |确保所有有线和/或无线流量都得到适当的加密。使用最佳实践进行身份验证协议，例如Kerberos，并确保可能包含凭据的Web流量受到SSL/TLS的保护。|
|[M1037]()|过滤网络流量|请考虑在交换机上启用DHCP Snooping和Dynamic ARP Inspection，以创建通过DHCP请求的IP地址与ARP表之间的映射，并将这些值绑定到交换机上的端口，从而可以阻止伪造流量。|
|[M1035]()|限制网络资源访问|为网络设备创建静态ARP条目。对于大型网络，实施静态ARP条目可能不可行。|
|[M1031]()|网络入侵防范|能够识别表明AiTM活动的流量模式的网络入侵检测和预防系统可用于缓解网络层面的活动。|
|[M1017()]|人员培训|培训用户对证书错误保持怀疑，攻击者可能使用他们自己的证书来尝试拦截HTTPS流量。当应用程序的证书与主机所期望的证书不一致时，可能会出现证书错误。|

### 检测

|  ID   | 缓解措施  | 描述|
|  ----  | ----  |----|
| [DS0029]()  |网络流量|网络流量内容|监控网络流量，注意异常的ARP流量，特别是不必要的ARP响应可能会引起怀疑。考虑收集端点上ARP缓存的变化情况以检测ARP欺骗攻击。例如，如果多个IP地址映射到单个MAC地址，则可能表明ARP缓存已被篡改。|
|[DS0029]()|网络流量|网络流量流|监控来自未知/意外硬件设备的网络流量。本地网络流量元数据（例如源MAC地址）以及使用DHCP等网络管理协议可能有助于识别硬件。|

## 中间人攻击：DHCP欺骗

攻击者可能通过欺骗动态主机配置协议（DHCP）流量并在受害网络上充当恶意DHCP服务器，将网络流量重定向到攻击者拥有的系统。通过实现中间人位置，攻击者可以收集网络通信，包括传递的凭据，特别是那些通过不安全、未加密协议发送的凭据。这也可能导致后续行为，如网络嗅探或传输数据篡改。

DHCP基于客户端-服务器模型，具有两个功能：一种协议用于从DHCP服务器向客户端提供网络配置设置，另一种机制用于为客户端分配网络地址。典型的服务器-客户端交互如下：

1. 客户端广播DISCOVER消息。
2. 服务器响应一个OFFER消息，其中包含可用的网络地址。
3. 客户端广播一个REQUEST消息，其中包括提供的网络地址。
4. 服务器通过ACK消息确认，并将网络配置参数发送给客户端。

攻击者可能会在受害网络上伪造一个恶意DHCP服务器，从而使合法主机接收到恶意的网络配置。例如，恶意软件可以充当DHCP服务器，并向受害计算机提供由攻击者拥有的DNS服务器。通过恶意的网络配置，攻击者可以实现AiTM位置，将客户端流量路由通过攻击者控制的系统，并从客户端网络中收集信息。

DHCPv6客户端可以通过向All_DHCP_Relay_Agents_and_Servers组播地址发送INFORMATION-REQUEST（代码11）消息来接收网络配置信息，而无需分配IP地址。攻击者可能会使用其恶意DHCP服务器响应此请求消息，并提供恶意的网络配置。

除了建立一个AiTM位置，攻击者还可能滥用DHCP欺骗，通过产生许多广播DISCOVER消息来耗尽网络的DHCP分配池，从而进行DHCP耗尽攻击（即服务耗尽洪水）。


### 缓解措施


|  ID   | 缓解措施  | 描述|
|  ----  | ----  |----|
|[M1037]()|过滤网络流量|考虑在端口67和68上过滤来自未知或不受信任的DHCP服务器的流量。此外，可以在层交换机上启用端口安全性。此外，考虑在二层交换机上启用DHCP监听功能，以防止DHCP欺骗攻击和饥饿攻击。可以通过脚本或工具跟踪可用IP地址。另外，在网络中很少使用IPv6时，请禁止DHCPv6流量和传入路由器广告。|
|[M1031]()|网络入侵防范|能够识别表明AiTM活动的流量模式的网络入侵检测和预防系统可用于缓解网络层面的活动。|

### 检测

|  ID   | 数据源  | 数据组件|检测|
|  ----  | ----  |----|----|
| [DS0015]()  |应用程序日志| 应用程序日志内容|监视Windows日志（例如EID 1341、1342、1020和1063）以检测DHCP设置的更改。这些也可能突出显示DHCP问题，例如IP分配不足或已用完。|
| [DS0029]()  |网络流量|网络流量内容|监控网络流量，以寻找涉及DHCP的可疑/恶意行为，例如DNS和/或网关参数的更改。此外，还要监视网络流量以查找流氓DHCPv6活动。|
|[DS0029]()|网络流量|网络流量流|监控网络流量，寻找与已知AiTM行为异常相关的迹象。考虑监测涉及塑造网络流量的系统配置文件是否被修改。|