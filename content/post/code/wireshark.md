---
title: "用Wireshark看http下层的tcp"
date: 2019-03-24T08:34:32+08:00
showDate: true
draft: False
tags: ["network","tcp"]
categories: ["network"]
---

## 前言

最近看完了那本《计算机网络自顶向下方法》，书上推荐了一个流量分析工具wireshark，在看过一些wireshark的使用方法之后，我就想用它来看看http协议的tcp是传输层是怎样的。

## 开始

wireshark会捕捉经过某张网卡的所有流量然后帮我们解析出相应的协议。为了分析简单一点，我想访问一个简单的网站，于是就想到了访问路由器的控制界面。

打开浏览器，输入192.168.1.1，然后wireshark就会出现图下这些tcp分组。

![wireshark](./wireshark.png)

这些分组是过滤后的分组，过滤出来的就是这次http请求所有tcp分组。

在分析这些分组之前，先看看三次握手和四次挥手的图解

![tcp](./tcp.jpg)

### 握手过程

可以看到，第一个分组wireshark解析出来的就是一个SYN分组，SYN（同步序列编号（Synchronize Sequence Numbers））就是tcp的握手包，第一个包的source的ip是192.168.1.102， Destination是192.168.1.1，说明第一个包是我发个路由器的http服务请求发起tcp握手的。

第二个分组是192.168.1.1 -> 192.168.1.102的 ACK + SYN，ACK (Acknowledgement）表示确认分组，SYN表示发起同步，所有这个包就是表示确认收到对方发过来的同步分组并发起同步

第三个分组是192.168.102 -> 192.168.1.1的ACK，表示确认收到上一个分组。

从这里可以看到TCP的可靠传输的保证之一就是分组确认，如果一段时间分组没有被确认，发送方会重传分组。

### 数据传输过程

握手之后tcp就开始传输数据了，这里大部分分组都是192.168.1.1 -> 192.168.1.102，也是就服务器正在向我们传输数据，tcp分组所能携带的最大字节数有限制，所有只能将数据分成多个报文段。

![seq](./seq.png)

这里的seq就是tcp的序号字段，数据被分段之后为了保证数据能在接收方正常重组加上的字段，这也是TCP实现可靠传输的保证之一。

随便点开一个分组

![pdu](./pdu.png)

在tcp payload里面我们可以看到数据是http头的报文。这也看出了计网的分层思想，最高层应用的报文被当成下层PDU，到了接收方然后有一层一层抽出来。

### 挥手过程

数据传输完成后，如果在http headers里面没有指定keep-alive，服务器会主动断开连接,断开连接的过程涉及到四次分组发送

![fin](fin.png)

192.168.1.1 -> 192.168.1.102发送一个FIN

192.168.1.102 -> 192.168.1.1 发送一个ACK

192.168.1.102 -> 192.168.1.1 发送FIN

192.168.1.1 -> 192.168.1.102发送一个ACK

这也只是粗略的过程，还涉及到的一些细节我直接略过了。

## 总结

从传输层来看应用层的过程，确实可以稍微看得出http实现的原理，我这里也只是浅尝辄止了，没有很深入的去研究细节，但是通过使用wireshark也确实让我对网络起了很大兴趣，之前还用wireshark+arpspoof+burpsuit通过arp毒化获取局域网内主机的流量，然后重放，登录了室友的a站。


